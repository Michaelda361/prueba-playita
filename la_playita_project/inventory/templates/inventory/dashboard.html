{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Panel de Inventario{% endblock %}

{% block extra_css %}
<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --info-gradient: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        --danger-gradient: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }
    
    .lp-main-content {
        overflow-x: hidden;
    }
    
    .container-fluid {
        max-width: 100%;
        overflow-x: hidden;
    }
    
    .panel-header {
        background: var(--primary-gradient);
        color: white;
        padding: 2rem;
        border-radius: 16px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        max-width: 100%;
    }
    
    .stat-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        height: 100%;
        position: relative;
        overflow: hidden;
    }
    
    .stat-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: var(--primary-gradient);
        transform: scaleX(0);
        transition: transform 0.3s ease;
    }
    
    .stat-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(0,0,0,0.15);
    }
    
    .stat-card:hover::before {
        transform: scaleX(1);
    }
    
    .stat-icon {
        width: 56px;
        height: 56px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        margin-bottom: 1rem;
        position: relative;
    }
    
    .stat-icon::after {
        content: '';
        position: absolute;
        inset: -4px;
        border-radius: 16px;
        padding: 4px;
        background: inherit;
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        opacity: 0.3;
    }
    
    .stat-icon.primary { background: var(--primary-gradient); }
    .stat-icon.success { background: var(--success-gradient); }
    .stat-icon.warning { background: var(--warning-gradient); }
    .stat-icon.info { background: var(--info-gradient); }
    .stat-icon.danger { background: var(--danger-gradient); }
    
    .stat-value {
        font-size: 2.25rem;
        font-weight: 700;
        margin: 0.5rem 0;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }
    
    .stat-label {
        color: #64748b;
        font-size: 0.875rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .stat-change {
        display: inline-flex;
        align-items: center;
        gap: 0.25rem;
        font-size: 0.875rem;
        font-weight: 600;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        margin-top: 0.5rem;
    }
    
    .stat-change.positive {
        background: #d1fae5;
        color: #065f46;
    }
    
    .stat-change.negative {
        background: #fee2e2;
        color: #991b1b;
    }
    
    .chart-card {
        background: white;
        border-radius: 16px;
        padding: 1.5rem;
        box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        max-width: 100%;
    }
    
    .chart-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
    }
    
    .chart-title {
        font-size: 1.125rem;
        font-weight: 600;
        color: #1e293b;
    }
    
    .alert-card {
        background: white;
        border-left: 4px solid;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: start;
        gap: 1rem;
    }
    
    .alert-card:hover {
        box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        transform: translateX(4px);
    }
    
    .alert-card.critica { border-left-color: #dc2626; background: linear-gradient(90deg, #fef2f2 0%, white 100%); }
    .alert-card.alta { border-left-color: #ea580c; background: linear-gradient(90deg, #fff7ed 0%, white 100%); }
    .alert-card.media { border-left-color: #f59e0b; background: linear-gradient(90deg, #fffbeb 0%, white 100%); }
    
    .alert-icon {
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        flex-shrink: 0;
    }
    
    .alert-icon.critica { background: #fee2e2; color: #dc2626; }
    .alert-icon.alta { background: #ffedd5; color: #ea580c; }
    .alert-icon.media { background: #fef3c7; color: #f59e0b; }
    
    .alert-content {
        flex: 1;
    }
    
    .alert-title {
        font-weight: 600;
        color: #1e293b;
        margin-bottom: 0.25rem;
    }
    
    .alert-message {
        font-size: 0.875rem;
        color: #64748b;
        margin-bottom: 0.5rem;
    }
    
    .alert-meta {
        display: flex;
        gap: 1rem;
        font-size: 0.75rem;
        color: #94a3b8;
    }
    
    .quick-action-icon {
        width: 56px;
        height: 56px;
        min-width: 56px;
        border-radius: 14px;
        background: var(--primary-gradient);
        color: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.75rem;
        flex-shrink: 0;
    }
    
    .btn-lg {
        padding: 1rem 1.25rem;
        border-radius: 12px;
        transition: all 0.3s ease;
    }
    
    .btn-lg:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 20px rgba(0,0,0,0.12);
    }
    
    .badge-custom {
        padding: 0.375rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .badge-critica { background: #fee2e2; color: #991b1b; }
    .badge-alta { background: #ffedd5; color: #9a3412; }
    .badge-media { background: #fef3c7; color: #92400e; }
    
    @media (max-width: 768px) {
        .stat-value { font-size: 1.75rem; }
        .panel-header { padding: 1.5rem; }
        .panel-header h1 { font-size: 1.5rem; }
        .chart-card { padding: 1rem; }
        .stat-card { padding: 1rem; }
        .stat-icon { width: 48px; height: 48px; font-size: 1.5rem; }
        .quick-action-icon { width: 48px; height: 48px; min-width: 48px; font-size: 1.5rem; }
        .btn-lg { padding: 0.875rem 1rem; font-size: 0.95rem; }
        .container-fluid { padding-left: 1rem; padding-right: 1rem; }
    }
    
    @media (max-width: 576px) {
        .stat-value { font-size: 1.5rem; }
        .stat-label { font-size: 0.75rem; }
        .chart-title { font-size: 1rem; }
        .alert-card { padding: 0.75rem; gap: 0.75rem; }
        .alert-icon { width: 32px; height: 32px; font-size: 1rem; }
        .alert-title { font-size: 0.875rem; }
        .alert-message { font-size: 0.75rem; }
        .quick-action-icon { width: 40px; height: 40px; min-width: 40px; font-size: 1.25rem; }
        .btn-lg { padding: 0.75rem; font-size: 0.875rem; }
        .btn-lg small { font-size: 0.7rem; }
        .container-fluid { padding-left: 0.5rem; padding-right: 0.5rem; }
        .panel-header { padding: 1rem; margin-bottom: 1rem; }
    }
    
    /* Animaciones */
    @keyframes fadeInUp {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }
    
    .animate-in {
        animation: fadeInUp 0.6s ease-out forwards;
    }
    
    .animate-in:nth-child(1) { animation-delay: 0.1s; }
    .animate-in:nth-child(2) { animation-delay: 0.2s; }
    .animate-in:nth-child(3) { animation-delay: 0.3s; }
    .animate-in:nth-child(4) { animation-delay: 0.4s; }
</style>
{% endblock %}

{% block content %}
<!-- Encabezado -->
<div class="panel-header animate-in">
        <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
            <div>
                <h1 class="mb-2">游늵 Panel de Inventario</h1>
                <p class="mb-0 opacity-90">Gesti칩n inteligente y en tiempo real</p>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-light" onclick="location.reload()">
                    <i class="bi bi-arrow-clockwise"></i> Actualizar
                </button>
                <button class="btn btn-light" onclick="window.print()">
                    <i class="bi bi-printer"></i> Imprimir
                </button>
            </div>
        </div>
    </div>

    <!-- KPIs Principales -->
    <div class="row g-4 mb-4">
        <div class="col-12 col-sm-6 col-lg-3 animate-in">
            <div class="stat-card">
                <div class="stat-icon primary">
                    <i class="bi bi-currency-dollar text-white"></i>
                </div>
                <div class="stat-label">Valor Total del Inventario</div>
                <div class="stat-value" id="valor-total">$0</div>
                <div class="stat-change positive">
                    <i class="bi bi-arrow-up"></i> 12% respecto al mes anterior
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3 animate-in">
            <div class="stat-card">
                <div class="stat-icon success">
                    <i class="bi bi-box-seam text-white"></i>
                </div>
                <div class="stat-label">Productos Activos</div>
                <div class="stat-value" id="productos-activos">0</div>
                <div class="stat-change positive">
                    <i class="bi bi-arrow-up"></i> 8 productos nuevos
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3 animate-in">
            <div class="stat-card">
                <div class="stat-icon danger">
                    <i class="bi bi-exclamation-triangle text-white"></i>
                </div>
                <div class="stat-label">Alertas Cr칤ticas</div>
                <div class="stat-value" id="alertas-criticas">0</div>
                <div class="stat-change negative">
                    <i class="bi bi-arrow-down"></i> Requiere atenci칩n
                </div>
            </div>
        </div>

        <div class="col-12 col-sm-6 col-lg-3 animate-in">
            <div class="stat-card">
                <div class="stat-icon info">
                    <i class="bi bi-arrow-left-right text-white"></i>
                </div>
                <div class="stat-label">Movimientos Hoy</div>
                <div class="stat-value" id="movimientos-hoy">0</div>
                <div class="stat-change positive">
                    <i class="bi bi-arrow-up"></i> 15% m치s actividad
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Gr치ficos -->
        <div class="col-12 col-lg-8">
            <div class="row g-4">
                <!-- Valor por Categor칤a -->
                <div class="col-12">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h5 class="chart-title">游늵 Valor de Inventario por Categor칤a</h5>
                            <select class="form-select form-select-sm" style="width: auto;" id="periodo-categoria">
                                <option value="30">칔ltimo mes</option>
                                <option value="90">칔ltimos 3 meses</option>
                                <option value="365">칔ltimo a침o</option>
                            </select>
                        </div>
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="chartCategoria"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Movimientos -->
                <div class="col-12">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h5 class="chart-title">游늳 Movimientos de Inventario (30 d칤as)</h5>
                            <div class="btn-group btn-group-sm" role="group" id="filtro-movimientos">
                                <button type="button" class="btn btn-outline-primary active" data-tipo="todos">Todos</button>
                                <button type="button" class="btn btn-outline-primary" data-tipo="entradas">Entradas</button>
                                <button type="button" class="btn btn-outline-primary" data-tipo="salidas">Salidas</button>
                            </div>
                        </div>
                        <div style="position: relative; height: 300px; width: 100%;">
                            <canvas id="chartMovimientos"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Top Productos -->
                <div class="col-12">
                    <div class="chart-card">
                        <div class="chart-header">
                            <h5 class="chart-title">游끥 Top 10 Productos por Valor</h5>
                            <a href="{% url 'inventory:productos_list' %}" class="btn btn-sm btn-outline-primary">
                                Ver todos
                            </a>
                        </div>
                        <div style="position: relative; height: 400px; width: 100%;">
                            <canvas id="chartTopProductos"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Derecho -->
        <div class="col-12 col-lg-4">
            <!-- Alertas Cr칤ticas -->
            <div class="chart-card mb-4" style="max-height: 500px; overflow-y: auto;">
                <div class="chart-header">
                    <h5 class="chart-title">游댒 Alertas Cr칤ticas</h5>
                    <a href="{% url 'inventory:alertas_stock' %}" class="btn btn-sm btn-outline-primary">
                        Ver todas
                    </a>
                </div>
                <div id="alertas-container">
                    <!-- Las alertas se cargar치n din치micamente -->
                    <div class="text-center py-4 text-muted">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                        <p class="mt-2 mb-0">Cargando alertas...</p>
                    </div>
                </div>
            </div>

            <!-- Acciones R치pidas -->
            <div class="chart-card" style="position: sticky; top: 20px;">
                <h5 class="chart-title mb-4">游 Acciones R치pidas</h5>
                <div class="d-grid gap-3">
                    <a href="{% url 'inventory:producto_create' %}" class="btn btn-outline-primary btn-lg d-flex align-items-center gap-3 text-start">
                        <div class="quick-action-icon">
                            <i class="bi bi-plus-circle"></i>
                        </div>
                        <div>
                            <div class="fw-bold">Nuevo Producto</div>
                            <small class="text-muted">Agregar producto al inventario</small>
                        </div>
                    </a>
                    
                    <a href="{% url 'suppliers:reabastecimiento_list' %}" class="btn btn-outline-success btn-lg d-flex align-items-center gap-3 text-start">
                        <div class="quick-action-icon" style="background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);">
                            <i class="bi bi-box-arrow-in-down"></i>
                        </div>
                        <div>
                            <div class="fw-bold">Recibir Mercanc칤a</div>
                            <small class="text-muted">Registrar entrada de productos</small>
                        </div>
                    </a>
                    
                    <a href="{% url 'inventory:ajustes_list' %}" class="btn btn-outline-warning btn-lg d-flex align-items-center gap-3 text-start">
                        <div class="quick-action-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <i class="bi bi-arrow-left-right"></i>
                        </div>
                        <div>
                            <div class="fw-bold">Ajuste de Stock</div>
                            <small class="text-muted">Corregir inventario f칤sico</small>
                        </div>
                    </a>
                    
                    <a href="{% url 'inventory:reportes' %}" class="btn btn-outline-info btn-lg d-flex align-items-center gap-3 text-start">
                        <div class="quick-action-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <i class="bi bi-file-earmark-bar-graph"></i>
                        </div>
                        <div>
                            <div class="fw-bold">Generar Reporte</div>
                            <small class="text-muted">Exportar datos de inventario</small>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Cargar datos del panel
    cargarPanel();
    
    // Actualizar cada 30 segundos
    setInterval(cargarPanel, 30000);
});

async function cargarPanel() {
    try {
        const response = await fetch('/api/inventory/dashboard-stats/');
        const data = await response.json();
        
        // Actualizar indicadores
        document.getElementById('valor-total').textContent = formatCurrency(data.valor_total);
        document.getElementById('productos-activos').textContent = data.productos_activos;
        document.getElementById('alertas-criticas').textContent = data.alertas_criticas;
        document.getElementById('movimientos-hoy').textContent = data.movimientos_hoy;
        
        // Cargar alertas
        cargarAlertas();
        
        // Inicializar gr치ficos
        inicializarGraficos(data);
    } catch (error) {
        console.error('Error cargando panel:', error);
    }
}

async function cargarAlertas() {
    try {
        const response = await fetch('/api/inventory/alertas/?estado=activa&prioridad=critica&limit=5');
        const data = await response.json();
        
        const container = document.getElementById('alertas-container');
        
        if (data.results && data.results.length > 0) {
            container.innerHTML = data.results.map(alerta => `
                <div class="alert-card ${alerta.prioridad}" onclick="verAlerta(${alerta.id})">
                    <div class="alert-icon ${alerta.prioridad}">
                        ${getAlertIcon(alerta.tipo_alerta)}
                    </div>
                    <div class="alert-content">
                        <div class="alert-title">${alerta.titulo}</div>
                        <div class="alert-message">${alerta.mensaje}</div>
                        <div class="alert-meta">
                            <span><i class="bi bi-clock"></i> ${formatTimeAgo(alerta.fecha_generacion)}</span>
                            <span class="badge-custom badge-${alerta.prioridad}">${alerta.prioridad}</span>
                        </div>
                    </div>
                </div>
            `).join('');
        } else {
            container.innerHTML = `
                <div class="text-center py-4 text-muted">
                    <i class="bi bi-check-circle" style="font-size: 3rem; color: #10b981;"></i>
                    <p class="mt-2 mb-0">춰Todo en orden!</p>
                    <small>No hay alertas cr칤ticas</small>
                </div>
            `;
        }
    } catch (error) {
        console.error('Error cargando alertas:', error);
    }
}

function getAlertIcon(tipo) {
    const icons = {
        'sin_stock': '<i class="bi bi-x-circle"></i>',
        'stock_critico': '<i class="bi bi-exclamation-triangle"></i>',
        'stock_bajo': '<i class="bi bi-exclamation-circle"></i>',
        'vencido': '<i class="bi bi-calendar-x"></i>',
        'proximo_vencer': '<i class="bi bi-calendar-event"></i>',
        'sobre_stock': '<i class="bi bi-arrow-up-circle"></i>',
        'rotacion_baja': '<i class="bi bi-arrow-repeat"></i>'
    };
    return icons[tipo] || '<i class="bi bi-bell"></i>';
}

function formatCurrency(value) {
    return new Intl.NumberFormat('es-CO', {
        style: 'currency',
        currency: 'COP',
        minimumFractionDigits: 0
    }).format(value);
}

function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diff = Math.floor((now - date) / 1000); // segundos
    
    if (diff < 60) return 'Hace un momento';
    if (diff < 3600) return `Hace ${Math.floor(diff / 60)} min`;
    if (diff < 86400) return `Hace ${Math.floor(diff / 3600)} horas`;
    return `Hace ${Math.floor(diff / 86400)} d칤as`;
}

function verAlerta(id) {
    window.location.href = `/inventory/alertas/${id}/`;
}

let chartCategoria, chartMovimientos, chartTopProductos;

function inicializarGraficos(data) {
    // Destruir gr치ficos existentes
    if (chartCategoria) chartCategoria.destroy();
    if (chartMovimientos) chartMovimientos.destroy();
    if (chartTopProductos) chartTopProductos.destroy();
    
    // Gr치fico de Valor por Categor칤a
    const ctxCategoria = document.getElementById('chartCategoria');
    if (ctxCategoria && data.valor_por_categoria && data.valor_por_categoria.length > 0) {
        const categorias = data.valor_por_categoria.map(c => c.nombre);
        const valores = data.valor_por_categoria.map(c => parseFloat(c.valor || 0));
        
        chartCategoria = new Chart(ctxCategoria, {
            type: 'bar',
            data: {
                labels: categorias,
                datasets: [{
                    label: 'Valor Inventario',
                    data: valores,
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(118, 75, 162, 0.8)',
                        'rgba(17, 153, 142, 0.8)',
                        'rgba(56, 239, 125, 0.8)',
                        'rgba(79, 172, 254, 0.8)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return formatCurrency(context.parsed.y);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + (value / 1000).toFixed(0) + 'K';
                            }
                        }
                    }
                }
            }
        });
    } else {
        ctxCategoria.parentElement.innerHTML = '<div class="text-center py-5 text-muted">No hay datos disponibles</div>';
    }
    
    // Gr치fico de Top Productos
    const ctxTop = document.getElementById('chartTopProductos');
    if (ctxTop && data.top_productos && data.top_productos.length > 0) {
        const productos = data.top_productos.map(p => p.nombre.substring(0, 25));
        const valores = data.top_productos.map(p => parseFloat(p.valor_total || 0));
        
        chartTopProductos = new Chart(ctxTop, {
            type: 'bar',
            data: {
                labels: productos,
                datasets: [{
                    label: 'Valor',
                    data: valores,
                    backgroundColor: [
                        'rgba(102, 126, 234, 0.8)',
                        'rgba(118, 75, 162, 0.8)',
                        'rgba(17, 153, 142, 0.8)',
                        'rgba(56, 239, 125, 0.8)',
                        'rgba(79, 172, 254, 0.8)',
                        'rgba(0, 242, 254, 0.8)',
                        'rgba(250, 112, 154, 0.8)',
                        'rgba(254, 225, 64, 0.8)',
                        'rgba(240, 147, 251, 0.8)',
                        'rgba(245, 87, 108, 0.8)'
                    ],
                    borderWidth: 0
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return formatCurrency(context.parsed.x);
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + (value / 1000).toFixed(0) + 'K';
                            }
                        }
                    }
                }
            }
        });
    } else {
        ctxTop.parentElement.innerHTML = '<div class="text-center py-5 text-muted">No hay datos disponibles</div>';
    }
    
    // Gr치fico de Movimientos (칰ltimos 7 d칤as)
    const ctxMov = document.getElementById('chartMovimientos');
    if (ctxMov) {
        const labels = ['Lun', 'Mar', 'Mi칠', 'Jue', 'Vie', 'S치b', 'Dom'];
        const dataEntradas = [12, 19, 15, 25, 22, 18, 10];
        const dataSalidas = [8, 15, 12, 20, 18, 14, 8];
        
        chartMovimientos = new Chart(ctxMov, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Entradas',
                    data: dataEntradas,
                    borderColor: 'rgba(17, 153, 142, 1)',
                    backgroundColor: 'rgba(17, 153, 142, 0.1)',
                    tension: 0.4,
                    fill: true
                }, {
                    label: 'Salidas',
                    data: dataSalidas,
                    borderColor: 'rgba(245, 87, 108, 1)',
                    backgroundColor: 'rgba(245, 87, 108, 0.1)',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
    }
}

// Event listeners para filtros
document.addEventListener('DOMContentLoaded', function() {
    // Filtro de movimientos
    const filtroMovimientos = document.getElementById('filtro-movimientos');
    if (filtroMovimientos) {
        filtroMovimientos.addEventListener('click', function(e) {
            if (e.target.tagName === 'BUTTON') {
                // Actualizar botones activos
                filtroMovimientos.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
                e.target.classList.add('active');
                
                // Actualizar gr치fico seg칰n filtro
                const tipo = e.target.dataset.tipo;
                actualizarGraficoMovimientos(tipo);
            }
        });
    }
    
    // Filtro de per칤odo categor칤as
    const periodoCategoria = document.getElementById('periodo-categoria');
    if (periodoCategoria) {
        periodoCategoria.addEventListener('change', function() {
            cargarDashboard();
        });
    }
});

function actualizarGraficoMovimientos(tipo) {
    if (!chartMovimientos) return;
    
    const datasets = chartMovimientos.data.datasets;
    
    if (tipo === 'todos') {
        datasets[0].hidden = false;
        datasets[1].hidden = false;
    } else if (tipo === 'entradas') {
        datasets[0].hidden = false;
        datasets[1].hidden = true;
    } else if (tipo === 'salidas') {
        datasets[0].hidden = true;
        datasets[1].hidden = false;
    }
    
    chartMovimientos.update();
}
</script>
{% endblock %}
