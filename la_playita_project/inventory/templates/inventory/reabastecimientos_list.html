{% extends 'core/base.html' %}
{% load static %}
{% load humanize %}

{% block title %}Reabastecimientos - Inventario{% endblock %}

{% block extra_css %}
<style>
    .reabastecimiento-card {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.2s;
        margin-bottom: 1rem;
        border-left: 4px solid;
    }
    .reabastecimiento-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0,0,0,0.12);
    }
    .estado-pendiente { border-left-color: #ffc107; background: #fffbf0; }
    .estado-recibido { border-left-color: #28a745; background: #f8fff8; }
    .estado-parcial { border-left-color: #17a2b8; background: #f0f9ff; }
    .estado-cancelado { border-left-color: #dc3545; background: #fff5f5; }
    
    .badge-pendiente { background-color: #ffc107; color: #000; }
    .badge-recibido { background-color: #28a745; }
    .badge-parcial { background-color: #17a2b8; }
    .badge-cancelado { background-color: #dc3545; }
    
    .producto-item {
        padding: 0.75rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 0.5rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1">üöö √ìrdenes de Reabastecimiento</h2>
            <p class="text-muted mb-0">Gestiona las compras a proveedores</p>
        </div>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="exportarReabastecimientos()">
                <i class="bi bi-file-earmark-excel"></i> Exportar
            </button>
            <button class="btn btn-primary" onclick="mostrarModalNuevo()">
                <i class="bi bi-plus-circle"></i> Nueva Orden
            </button>
        </div>
    </div>

    <!-- Filtros -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-3">
                    <label class="form-label small">Estado</label>
                    <select class="form-select" id="filtro-estado" onchange="aplicarFiltros()">
                        <option value="">Todos</option>
                        <option value="pendiente">Pendiente</option>
                        <option value="recibido">Recibido</option>
                        <option value="parcial">Parcial</option>
                        <option value="cancelado">Cancelado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Proveedor</label>
                    <select class="form-select" id="filtro-proveedor" onchange="aplicarFiltros()">
                        <option value="">Todos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Desde</label>
                    <input type="date" class="form-control" id="filtro-desde" onchange="aplicarFiltros()">
                </div>
                <div class="col-md-3">
                    <label class="form-label small">Hasta</label>
                    <input type="date" class="form-control" id="filtro-hasta" onchange="aplicarFiltros()">
                </div>
            </div>
        </div>
    </div>

    <!-- Resumen -->
    <div class="row g-3 mb-4">
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h3 class="mb-0" id="total-ordenes">0</h3>
                    <small class="text-muted">√ìrdenes Totales</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h3 class="mb-0 text-warning" id="ordenes-pendientes">0</h3>
                    <small class="text-muted">Pendientes</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h3 class="mb-0 text-success" id="ordenes-recibidas">0</h3>
                    <small class="text-muted">Recibidas</small>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card border-0 shadow-sm">
                <div class="card-body text-center">
                    <h3 class="mb-0 text-primary" id="valor-total">$0</h3>
                    <small class="text-muted">Valor Total</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista de Reabastecimientos -->
    <div id="reabastecimientos-container">
        <div class="text-center py-5">
            <div class="spinner-border text-primary"></div>
            <p class="mt-3 text-muted">Cargando √≥rdenes...</p>
        </div>
    </div>

    <!-- Paginaci√≥n -->
    <nav aria-label="Paginaci√≥n" class="mt-4">
        <ul class="pagination justify-content-center" id="pagination-container"></ul>
    </nav>
</div>

<!-- Modal Detalle -->
<div class="modal fade" id="detalleModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Detalle de Orden</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detalle-body">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-success" id="btn-marcar-recibido" onclick="marcarRecibido()">
                    <i class="bi bi-check-circle"></i> Marcar como Recibido
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal Nueva Orden -->
<div class="modal fade" id="nuevoModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Nueva Orden de Compra</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="form-nuevo-reabastecimiento">
                    <div class="mb-3">
                        <label class="form-label">Proveedor *</label>
                        <select class="form-select" id="nuevo-proveedor" required>
                            <option value="">Seleccione...</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Fecha de Entrega Esperada *</label>
                        <input type="date" class="form-control" id="nuevo-fecha-entrega" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Observaciones</label>
                        <textarea class="form-control" id="nuevo-observaciones" rows="3"></textarea>
                    </div>
                    <hr>
                    <h6>Productos</h6>
                    <div id="productos-lista">
                        <div class="producto-item-form mb-2">
                            <div class="row g-2">
                                <div class="col-md-6">
                                    <select class="form-select producto-select" required>
                                        <option value="">Seleccione producto...</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control cantidad-input" placeholder="Cantidad" min="1" required>
                                </div>
                                <div class="col-md-3">
                                    <input type="number" class="form-control costo-input" placeholder="Costo Unit." step="0.01" min="0" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="agregarProductoLinea()">
                        <i class="bi bi-plus"></i> Agregar Producto
                    </button>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" onclick="guardarNuevoReabastecimiento()">
                    <i class="bi bi-save"></i> Crear Orden
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilters = {};
let reabastecimientoActual = null;

// Cargar proveedores
async function cargarProveedores() {
    try {
        const response = await fetch('/api/suppliers/proveedores/');
        const data = await response.json();
        
        const selects = ['filtro-proveedor', 'nuevo-proveedor'];
        selects.forEach(selectId => {
            const select = document.getElementById(selectId);
            data.results.forEach(prov => {
                const option = document.createElement('option');
                option.value = prov.id;
                option.textContent = prov.nombre_empresa;
                select.appendChild(option);
            });
        });
    } catch (error) {
        console.error('Error cargando proveedores:', error);
    }
}

// Cargar productos para el formulario
async function cargarProductosForm() {
    try {
        const response = await fetch('/api/inventory/productos/?page_size=1000');
        const data = await response.json();
        
        window.productosDisponibles = data.results;
        actualizarSelectsProductos();
    } catch (error) {
        console.error('Error cargando productos:', error);
    }
}

function actualizarSelectsProductos() {
    document.querySelectorAll('.producto-select').forEach(select => {
        select.innerHTML = '<option value="">Seleccione producto...</option>';
        window.productosDisponibles.forEach(prod => {
            const option = document.createElement('option');
            option.value = prod.id;
            option.textContent = `${prod.nombre} (Stock: ${prod.stock_actual})`;
            select.appendChild(option);
        });
    });
}

// Cargar reabastecimientos
async function cargarReabastecimientos(page = 1) {
    try {
        const params = new URLSearchParams({
            page: page,
            ...currentFilters
        });
        
        const response = await fetch(`/api/suppliers/reabastecimientos/?${params}`);
        const data = await response.json();
        
        mostrarReabastecimientos(data.results);
        actualizarResumen(data);
        actualizarPaginacion(data);
        
    } catch (error) {
        console.error('Error:', error);
        document.getElementById('reabastecimientos-container').innerHTML = 
            '<div class="alert alert-danger">Error al cargar √≥rdenes</div>';
    }
}

// Mostrar reabastecimientos
function mostrarReabastecimientos(reabastecimientos) {
    const container = document.getElementById('reabastecimientos-container');
    
    if (reabastecimientos.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="bi bi-inbox fs-1 text-muted"></i>
                <p class="mt-3 text-muted">No se encontraron √≥rdenes</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = reabastecimientos.map(reab => {
        const fecha = new Date(reab.fecha).toLocaleDateString('es-CO');
        const estadoClass = `estado-${reab.estado}`;
        const badgeClass = `badge-${reab.estado}`;
        
        return `
            <div class="reabastecimiento-card ${estadoClass}">
                <div class="row align-items-center">
                    <div class="col-md-2">
                        <h5 class="mb-1">#${reab.id}</h5>
                        <small class="text-muted">${fecha}</small>
                    </div>
                    <div class="col-md-3">
                        <strong class="d-block">${reab.proveedor_nombre}</strong>
                        <small class="text-muted">${reab.total_productos || 0} productos</small>
                    </div>
                    <div class="col-md-2 text-center">
                        <div class="fs-5 fw-bold text-success">$${(reab.costo_total || 0).toLocaleString('es-CO')}</div>
                    </div>
                    <div class="col-md-2 text-center">
                        <span class="badge ${badgeClass}">${reab.estado_display || reab.estado.toUpperCase()}</span>
                    </div>
                    <div class="col-md-3 text-end">
                        <button class="btn btn-sm btn-outline-primary" onclick="verDetalle(${reab.id})">
                            <i class="bi bi-eye"></i> Ver Detalle
                        </button>
                        ${reab.estado === 'pendiente' ? `
                            <button class="btn btn-sm btn-success" onclick="verDetalle(${reab.id}, true)">
                                <i class="bi bi-check"></i> Recibir
                            </button>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// Ver detalle
async function verDetalle(id, marcarRecibir = false) {
    const modal = new bootstrap.Modal(document.getElementById('detalleModal'));
    modal.show();
    
    reabastecimientoActual = id;
    
    try {
        const response = await fetch(`/api/suppliers/reabastecimientos/${id}/`);
        const reab = await response.json();
        
        const detallesResponse = await fetch(`/api/suppliers/reabastecimiento-detalles/?reabastecimiento=${id}`);
        const detallesData = await detallesResponse.json();
        
        document.getElementById('detalle-body').innerHTML = `
            <div class="row mb-4">
                <div class="col-md-6">
                    <h6>Informaci√≥n General</h6>
                    <table class="table table-sm">
                        <tr><th>Orden:</th><td>#${reab.id}</td></tr>
                        <tr><th>Proveedor:</th><td>${reab.proveedor_nombre}</td></tr>
                        <tr><th>Fecha:</th><td>${new Date(reab.fecha).toLocaleDateString('es-CO')}</td></tr>
                        <tr><th>Estado:</th><td><span class="badge badge-${reab.estado}">${reab.estado.toUpperCase()}</span></td></tr>
                    </table>
                </div>
                <div class="col-md-6">
                    <h6>Totales</h6>
                    <table class="table table-sm">
                        <tr><th>Total Productos:</th><td>${detallesData.results.length}</td></tr>
                        <tr><th>Total Unidades:</th><td>${detallesData.results.reduce((sum, d) => sum + d.cantidad, 0)}</td></tr>
                        <tr><th>Costo Total:</th><td class="fs-5 fw-bold text-success">$${(reab.costo_total || 0).toLocaleString('es-CO')}</td></tr>
                    </table>
                </div>
            </div>
            
            <h6>Productos</h6>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>Producto</th>
                            <th class="text-center">Cantidad</th>
                            <th class="text-end">Costo Unit.</th>
                            <th class="text-end">Subtotal</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${detallesData.results.map(det => `
                            <tr>
                                <td><strong>${det.producto_nombre}</strong></td>
                                <td class="text-center">${det.cantidad}</td>
                                <td class="text-end">$${det.costo_unitario.toLocaleString('es-CO')}</td>
                                <td class="text-end">$${(det.cantidad * parseFloat(det.costo_unitario)).toLocaleString('es-CO')}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
        
        // Mostrar/ocultar bot√≥n de recibir
        const btnRecibir = document.getElementById('btn-marcar-recibido');
        if (reab.estado === 'pendiente') {
            btnRecibir.style.display = 'block';
        } else {
            btnRecibir.style.display = 'none';
        }
        
    } catch (error) {
        console.error('Error:', error);
    }
}

// Marcar como recibido
async function marcarRecibido() {
    if (!confirm('¬øConfirmar recepci√≥n de esta orden?')) return;
    
    try {
        const response = await fetch(`/api/suppliers/reabastecimientos/${reabastecimientoActual}/recibir/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        });
        
        if (response.ok) {
            alert('‚úÖ Orden marcada como recibida');
            bootstrap.Modal.getInstance(document.getElementById('detalleModal')).hide();
            cargarReabastecimientos(currentPage);
        } else {
            alert('‚ùå Error al marcar como recibida');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al marcar como recibida');
    }
}

// Mostrar modal nuevo
function mostrarModalNuevo() {
    const modal = new bootstrap.Modal(document.getElementById('nuevoModal'));
    modal.show();
}

// Agregar l√≠nea de producto
function agregarProductoLinea() {
    const container = document.getElementById('productos-lista');
    const newLine = document.createElement('div');
    newLine.className = 'producto-item-form mb-2';
    newLine.innerHTML = `
        <div class="row g-2">
            <div class="col-md-6">
                <select class="form-select producto-select" required>
                    <option value="">Seleccione producto...</option>
                </select>
            </div>
            <div class="col-md-2">
                <input type="number" class="form-control cantidad-input" placeholder="Cantidad" min="1" required>
            </div>
            <div class="col-md-3">
                <input type="number" class="form-control costo-input" placeholder="Costo Unit." step="0.01" min="0" required>
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-sm btn-danger w-100" onclick="this.closest('.producto-item-form').remove()">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
        </div>
    `;
    container.appendChild(newLine);
    actualizarSelectsProductos();
}

// Guardar nuevo reabastecimiento
async function guardarNuevoReabastecimiento() {
    const form = document.getElementById('form-nuevo-reabastecimiento');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }
    
    const productos = [];
    document.querySelectorAll('.producto-item-form').forEach(item => {
        const productoId = item.querySelector('.producto-select').value;
        const cantidad = item.querySelector('.cantidad-input').value;
        const costo = item.querySelector('.costo-input').value;
        
        if (productoId && cantidad && costo) {
            productos.push({
                producto_id: parseInt(productoId),
                cantidad: parseInt(cantidad),
                costo_unitario: parseFloat(costo)
            });
        }
    });
    
    if (productos.length === 0) {
        alert('Debe agregar al menos un producto');
        return;
    }
    
    const data = {
        proveedor_id: parseInt(document.getElementById('nuevo-proveedor').value),
        fecha_entrega: document.getElementById('nuevo-fecha-entrega').value,
        observaciones: document.getElementById('nuevo-observaciones').value,
        productos: productos
    };
    
    try {
        const response = await fetch('/api/suppliers/reabastecimientos/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        if (response.ok) {
            alert('‚úÖ Orden creada exitosamente');
            bootstrap.Modal.getInstance(document.getElementById('nuevoModal')).hide();
            form.reset();
            cargarReabastecimientos(1);
        } else {
            const error = await response.json();
            alert('‚ùå Error: ' + JSON.stringify(error));
        }
    } catch (error) {
        console.error('Error:', error);
        alert('‚ùå Error al crear orden');
    }
}

// Aplicar filtros
function aplicarFiltros() {
    currentFilters = {};
    
    const estado = document.getElementById('filtro-estado').value;
    if (estado) currentFilters.estado = estado;
    
    const proveedor = document.getElementById('filtro-proveedor').value;
    if (proveedor) currentFilters.proveedor = proveedor;
    
    const desde = document.getElementById('filtro-desde').value;
    if (desde) currentFilters.fecha_desde = desde;
    
    const hasta = document.getElementById('filtro-hasta').value;
    if (hasta) currentFilters.fecha_hasta = hasta;
    
    currentPage = 1;
    cargarReabastecimientos(1);
}

// Actualizar resumen
function actualizarResumen(data) {
    document.getElementById('total-ordenes').textContent = data.count || 0;
    
    const pendientes = data.results.filter(r => r.estado === 'pendiente').length;
    const recibidas = data.results.filter(r => r.estado === 'recibido').length;
    const valorTotal = data.results.reduce((sum, r) => sum + parseFloat(r.costo_total || 0), 0);
    
    document.getElementById('ordenes-pendientes').textContent = pendientes;
    document.getElementById('ordenes-recibidas').textContent = recibidas;
    document.getElementById('valor-total').textContent = '$' + valorTotal.toLocaleString('es-CO');
}

// Actualizar paginaci√≥n
function actualizarPaginacion(data) {
    const container = document.getElementById('pagination-container');
    const totalPages = Math.ceil(data.count / 25);
    
    if (totalPages <= 1) {
        container.innerHTML = '';
        return;
    }
    
    let html = `
        <li class="page-item ${!data.previous ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="cargarReabastecimientos(${currentPage - 1}); return false;">Anterior</a>
        </li>
    `;
    
    for (let i = 1; i <= Math.min(totalPages, 5); i++) {
        html += `
            <li class="page-item ${i === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" onclick="cargarReabastecimientos(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    html += `
        <li class="page-item ${!data.next ? 'disabled' : ''}">
            <a class="page-link" href="#" onclick="cargarReabastecimientos(${currentPage + 1}); return false;">Siguiente</a>
        </li>
    `;
    
    container.innerHTML = html;
}

// Exportar
function exportarReabastecimientos() {
    window.location.href = '/api/suppliers/reabastecimientos/export/';
}

// Inicializar
document.addEventListener('DOMContentLoaded', function() {
    cargarProveedores();
    cargarProductosForm();
    cargarReabastecimientos();
});
</script>
{% endblock %}
