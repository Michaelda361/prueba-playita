{% extends 'core/base.html' %}
{% block title %}Reabastecimientos{% endblock %}

{% load reabastecimiento_extras %}
{% load tz %}
{% load static %}
{% load humanize %}
{% load auth_extras %}
{% load number_extras %}
{% load currency_format %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
<link rel="stylesheet" href="{% static 'suppliers/css/reabastecimiento.css' %}">
{% endblock %}

{% block content %}

<div class="container-fluid py-4" id="reabastecimiento-container"
     data-recibir-url="{% url 'suppliers:reabastecimiento_recibir' 0 %}"
     data-eliminar-url="{% url 'suppliers:reabastecimiento_eliminar' 0 %}"
     data-detail-url="{% url 'suppliers:reabastecimiento_editar' 0 %}"
     data-update-url="{% url 'suppliers:reabastecimiento_update' 0 %}"
     data-row-api-url="{% url 'suppliers:reabastecimiento_row_api' 0 %}"
     data-proveedores-search-url="{% url 'suppliers:api_search_proveedores' %}"
     data-productos-search-url="{% url 'suppliers:api_search_productos' %}">

    <!-- Header Mejorado -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="text-primary fw-bold mb-0">
                <i class="fas fa-boxes me-2"></i>Órdenes de Reabastecimiento
            </h2>
            <small class="text-muted">Gestiona tus órdenes de compra y recepción de mercancía</small>
        </div>
        <a href="{% url 'suppliers:reabastecimiento_create' %}" class="btn btn-primary btn-lg shadow-sm">
            <i class="fas fa-plus me-2"></i>Nueva Orden
        </a>
    </div>

    <!-- Tabs de Navegación -->
    <div class="card shadow-sm mb-4">
        <div class="card-body p-0 border-bottom">
            <div class="d-flex" style="border-bottom: 1px solid #dee2e6;">
                <button class="tab-btn active" data-tab="pendientes">
                    <i class="fas fa-hourglass-half me-2"></i>
                    Pendientes
                    <span class="badge bg-warning text-dark ms-2" id="count-pendientes">0</span>
                </button>
                <button class="tab-btn" data-tab="historial">
                    <i class="fas fa-history me-2"></i>
                    Historial
                    <span class="badge bg-secondary ms-2" id="count-historial">0</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Búsqueda Unificada -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <div class="search-bar">
                <div class="input-group input-group-lg">
                    <span class="input-group-text bg-white border-end-0">
                        <i class="fas fa-search text-muted"></i>
                    </span>
                    <input type="text" 
                           id="global_search" 
                           class="form-control form-control-lg border-start-0" 
                           placeholder="Buscar por ID, proveedor o producto..."
                           autocomplete="off"
                           aria-label="Búsqueda global">
                    <button type="button" class="search-clear-btn" id="clearSearchBtn" style="display: none;">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-secondary" id="toggleFiltersBtn">
                    <i class="fas fa-sliders-h me-1"></i>Filtros Avanzados
                </button>
            </div>
        </div>
    </div>

    <!-- Filtros Avanzados (Colapsable) -->
    <div class="filter-collapse" id="filtersCollapse">
        <div class="card shadow-sm mb-4">
            <div class="card-body">
                <form class="row g-2" id="filterForm">
                    <div class="col-md-3">
                        <label for="filter_proveedor" class="form-label small">Proveedor</label>
                        <input type="text" 
                               name="proveedor_search" 
                               id="filter_proveedor" 
                               class="form-control form-control-sm"
                               placeholder="Buscar..."
                               autocomplete="off"
                               aria-label="Buscar proveedor">
                        <input type="hidden" name="proveedor_id" id="filter_proveedor_id" value="{{ request.GET.proveedor_id }}">
                        <div id="proveedor_suggestions" class="list-group position-absolute mt-1" style="display: none; width: 100%; z-index: 1000;"></div>
                    </div>
                    
                    <div class="col-md-2">
                        <label for="fecha_desde" class="form-label small">Desde</label>
                        <input type="date" name="fecha_desde" id="fecha_desde" class="form-control form-control-sm" value="{{ request.GET.fecha_desde }}" aria-label="Fecha desde">
                    </div>
                    
                    <div class="col-md-2">
                        <label for="fecha_hasta" class="form-label small">Hasta</label>
                        <input type="date" name="fecha_hasta" id="fecha_hasta" class="form-control form-control-sm" value="{{ request.GET.fecha_hasta }}" aria-label="Fecha hasta">
                    </div>

                    <div class="col-md-5 d-flex gap-2 align-items-end">
                        <button class="btn btn-primary btn-sm flex-grow-1" type="submit" aria-label="Aplicar filtros">
                            <i class="fas fa-search me-1"></i> Buscar
                        </button>
                        <a href="{% url 'suppliers:reabastecimiento_list' %}" class="btn btn-outline-secondary btn-sm" aria-label="Limpiar filtros">
                            <i class="fas fa-times me-1"></i> Limpiar
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Contenedor de datos oculto para el JS -->
    <div style="display: none;" id="data-container">
        {% for r in reabastecimientos %}
            <div data-reabastecimiento-id="{{ r.id }}" 
                 data-estado="{{ r.estado }}"
                 data-proveedor="{{ r.proveedor.nombre_empresa }}"
                 data-fecha="{{ r.fecha|date:'d/m/Y H:i' }}"
                 data-costo="{{ r.costo_total|default:0 }}"
                 data-product-count="{{ r.reabastecimientodetalle_set.count }}">
            </div>
        {% endfor %}
    </div>

    <!-- Contenedor de Tabs -->
    <div id="tab-pendientes" class="tab-content active">
        <div id="pendientes-list" class="orders-container">
            <!-- Las órdenes pendientes se cargarán aquí -->
        </div>
    </div>

    <div id="tab-historial" class="tab-content">
        <div id="historial-list" class="orders-container">
            <!-- El historial se cargará aquí -->
        </div>
    </div>

    <!-- Paginación -->
    {% if page_obj.has_other_pages %}
    <nav aria-label="Paginación" class="mt-4">
        <ul class="pagination justify-content-center flex-wrap">
            {% if page_obj.has_previous %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.previous_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">&laquo; Anterior</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">&laquo; Anterior</span></li>
            {% endif %}

            {% for i in page_obj.paginator.page_range %}
                {% if page_obj.number == i %}
                    <li class="page-item active"><span class="page-link">{{ i }} <span class="sr-only">(actual)</span></span></li>
                {% else %}
                    <li class="page-item"><a class="page-link" href="?page={{ i }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ i }}</a></li>
                {% endif %}
            {% endfor %}

            {% if page_obj.has_next %}
                <li class="page-item"><a class="page-link" href="?page={{ page_obj.next_page_number }}{% for key, value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">Siguiente &raquo;</a></li>
            {% else %}
                <li class="page-item disabled"><span class="page-link">Siguiente &raquo;</span></li>
            {% endif %}
        </ul>
    </nav>
    {% endif %}
</div>

<!-- Modal: Recibir Orden (Mejorado) -->
<div class="modal fade" id="receptionModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <!-- Header -->
            <div class="modal-header border-bottom">
                <div class="flex-grow-1">
                    <h5 class="modal-title">
                        <i class="fas fa-truck-loading text-success me-2"></i>
                        Recibir Orden #<span id="receptionOrderId" class="fw-bold text-primary"></span>
                    </h5>
                    <small class="text-muted d-block mt-1">
                        <i class="fas fa-building me-1"></i>
                        <span id="receptionProveedorName">Cargando...</span>
                    </small>
                </div>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>

            <!-- Body -->
            <div class="modal-body p-0">
                <!-- Quick Actions -->
                <div class="p-3 border-bottom bg-light">
                    <div class="row g-2">
                        <div class="col-md-6">
                            <button type="button" class="btn btn-sm btn-success w-100" id="markAllReceivedBtn">
                                <i class="fas fa-check-double me-1"></i> Marcar todo
                            </button>
                        </div>
                        <div class="col-md-6">
                            <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="saveDraftBtn">
                                <i class="fas fa-save me-1"></i> Guardar borrador
                            </button>
                        </div>
                        <div class="col-12">
                            <input type="text" class="form-control form-control-sm" id="searchProductInput" placeholder="Buscar producto..." autocomplete="off">
                        </div>
                        <div class="col-12">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-calendar-alt text-muted"></i>
                                </span>
                                <input type="date" class="form-control form-control-sm" id="generalExpiryDate">
                                <button class="btn btn-outline-secondary btn-sm" type="button" id="applyGeneralExpiryBtn">
                                    Aplicar a todos
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reception Table -->
                <form id="receptionForm">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0 reception-table">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 30%;">Producto</th>
                                    <th class="text-center" style="width: 12%;">Solicitado</th>
                                    <th class="text-center" style="width: 15%;">Recibido</th>
                                    <th class="text-center" style="width: 15%;">Caducidad</th>
                                    <th class="text-center" style="width: 12%;">Lote</th>
                                    <th class="text-center" style="width: 16%;">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="receptionTableBody">
                                <!-- Rows populated by JS -->
                            </tbody>
                        </table>
                    </div>
                </form>

                <!-- Progress Section -->
                <div class="p-3 border-top bg-light">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <small class="fw-bold">Progreso de Recepción</small>
                            <small class="text-muted" id="progressText">0 de 0</small>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" id="progressBar" role="progressbar" style="width: 0%;"></div>
                        </div>
                    </div>

                    <!-- Status Summary -->
                    <div class="row g-2">
                        <div class="col-4">
                            <div class="p-2 bg-success bg-opacity-10 rounded text-center">
                                <i class="fas fa-check-circle text-success d-block mb-1"></i>
                                <strong class="text-success d-block" id="completedCount">0</strong>
                                <small class="text-muted">Completo</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-warning bg-opacity-10 rounded text-center">
                                <i class="fas fa-exclamation-circle text-warning d-block mb-1"></i>
                                <strong class="text-warning d-block" id="partialCount">0</strong>
                                <small class="text-muted">Parcial</small>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-secondary bg-opacity-10 rounded text-center">
                                <i class="fas fa-circle text-secondary d-block mb-1"></i>
                                <strong class="text-secondary d-block" id="pendingCount">0</strong>
                                <small class="text-muted">Pendiente</small>
                            </div>
                        </div>
                    </div>

                    <!-- Alerts -->
                    <div id="validationAlert" class="alert alert-danger alert-sm mt-3 mb-0" role="alert" style="display: none;">
                        <small id="validationAlertText"></small>
                    </div>
                    <div id="quantityMismatchAlert" class="alert alert-warning alert-sm mt-3 mb-0" role="alert" style="display: none;">
                        <small>
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            <strong>Recepción Parcial:</strong> <span id="mismatchText"></span>
                        </small>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="modal-footer border-top">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Cancelar
                </button>
                <button type="button" class="btn btn-success" id="confirmReceptionBtn" disabled>
                    <i class="fas fa-check me-1"></i> Confirmar Recepción
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Editar Reabastecimiento -->
<div class="modal fade" id="editarReabastecimientoModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Reabastecimiento</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div id="editarLoadingSpinner" class="d-flex justify-content-center align-items-center position-absolute top-0 start-0 w-100 h-100 bg-white bg-opacity-75" style="z-index: 1050; display: none;">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                </div>
                <div id="editarModalContent">
                    <form id="editarReabastecimientoForm">
                        <!-- Form content will be loaded dynamically -->
                    </form>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary" id="guardarEdicionReabastecimientoBtn">Guardar Cambios</button>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3" style="z-index: 1100;"></div>

{% include 'inventory/_nueva_categoria_modal.html' %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="{% static 'suppliers/js/reabastecimiento_list.js' %}"></script>
{% endblock %}
