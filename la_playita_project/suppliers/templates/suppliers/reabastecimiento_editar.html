{% extends 'core/base.html' %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Editar Reabastecimiento #{{ reabastecimiento.id }}{% endblock %}

{% block extra_head %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
<link rel="stylesheet" href="{% static 'suppliers/css/reabastecimiento.css' %}">
<style>
    /* Remover box-shadow de inputs en tabla */
    .reab-table input,
    .reab-table select,
    .cantidad-input,
    .costo-unitario-input {
        box-shadow: none !important;
        border: 1px solid #dee2e6 !important;
    }
    
    .reab-table input:focus,
    .reab-table select:focus,
    .cantidad-input:focus,
    .costo-unitario-input:focus {
        box-shadow: none !important;
        border-color: #80bdff !important;
        outline: none !important;
    }
</style>
<style>
    /* Estilos simples para el select de IVA */
    .iva-select {
        border: 1px solid #dee2e6 !important;
        border-radius: 0.375rem !important;
        font-weight: 500 !important;
        color: #212529 !important;
        background-color: #fff !important;
        cursor: pointer !important;
    }
    
    .iva-select:hover {
        border-color: #0d6efd !important;
    }
    
    .iva-select:focus {
        border-color: #0d6efd !important;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25) !important;
        outline: 0 !important;
    }
    
    .iva-select option {
        padding: 0.5rem;
        background-color: #fff;
        color: #212529;
    }
    
    .iva-select option:first-child {
        color: #6c757d;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 reab-container">
    <div class="card shadow-sm">
        <div class="card-header reab-header text-white d-flex justify-content-between align-items-center">
            <div>
                <h2 class="h4 mb-0"><i class="fas fa-edit me-2"></i>Editar Orden #{{ reabastecimiento.id }}</h2>
                <small class="text-white-50">Modifica los detalles de tu orden de compra</small>
            </div>
            <a href="{% url 'suppliers:reabastecimiento_list' %}" class="btn btn-close btn-close-white" aria-label="Cerrar"></a>
        </div>
        <div class="card-body p-4">
            <form method="post" action="{% url 'suppliers:reabastecimiento_update' reabastecimiento.id %}" id="reabastecimientoForm" data-formset-prefix="{{ formset.prefix }}">
                {% csrf_token %}

                <!-- SECCIÓN 1: INFORMACIÓN BÁSICA -->
                <div class="reab-section">
                    <div class="reab-section-title">
                        <i class="fas fa-info-circle"></i>
                        Información del Reabastecimiento
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">{{ form.proveedor.label }}</label>
                            {{ form.proveedor }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Estado</label>
                            <p class="form-control-plaintext">
                                <span class="badge bg-warning text-dark">{{ reabastecimiento.get_estado_display }}</span>
                            </p>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">{{ form.forma_pago.label }}</label>
                            {{ form.forma_pago }}
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Fecha de Solicitud</label>
                            <p class="form-control-plaintext">{{ reabastecimiento.fecha|date:"d/m/Y H:i" }}</p>
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">{{ form.observaciones.label }}</label>
                            {{ form.observaciones }}
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold">{{ form.producto.label }}</label>
                            {{ form.producto|add_class:"form-control" }}
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 2: RESUMEN EN VIVO -->
                <div class="card border-0 shadow-sm mb-4" role="region" aria-label="Resumen de la orden">
                    <div class="card-body p-3">
                        <div class="row g-3">
                            <div class="col-md-3">
                                <div class="text-center">
                                    <small class="text-muted d-block mb-1"><i class="fas fa-box me-1"></i>Productos</small>
                                    <h5 class="mb-0" id="product-count">{{ formset.forms|length }}</h5>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <small class="text-muted d-block mb-1"><i class="fas fa-calculator me-1"></i>Subtotal</small>
                                    <h5 class="mb-0" id="gran-subtotal">${{ reabastecimiento.costo_total }}</h5>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <small class="text-muted d-block mb-1"><i class="fas fa-percent me-1"></i>IVA</small>
                                    <h5 class="mb-0 text-warning" id="gran-iva">${{ reabastecimiento.iva }}</h5>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center p-2 bg-success bg-opacity-10 rounded">
                                    <small class="text-muted d-block mb-1"><i class="fas fa-money-bill me-1"></i>Total</small>
                                    <h5 class="mb-0 text-success" id="gran-total">${{ reabastecimiento.costo_total|add:reabastecimiento.iva }}</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SECCIÓN 3: DETALLES DE PRODUCTOS -->
                <div class="reab-section">
                    <div class="reab-section-title">
                        <i class="fas fa-list"></i>
                        Productos
                    </div>

                    {{ formset.management_form }}
                    <div class="table-responsive">
                        <table class="table table-sm reab-table" id="detalleTable" role="grid" aria-label="Detalles de productos">
                            <thead class="table-light">
                                <tr role="row">
                                    <th style="width: 30%;" role="columnheader">Producto</th>
                                    <th class="text-center" style="width: 12%;" role="columnheader">Cant.</th>
                                    <th class="text-center" style="width: 12%;" role="columnheader">Costo</th>
                                    <th class="text-center" style="width: 8%;" role="columnheader">IVA</th>
                                    <th class="text-center" style="width: 14%;" role="columnheader">Caducidad</th>
                                    <th class="text-center" style="width: 12%;" role="columnheader">Subtotal</th>
                                    <th class="text-center" style="width: 12%;" role="columnheader">Acciones</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for f in formset.forms %}
                                <tr class="formset-row" id="detalle-row-{{ forloop.counter0 }}" role="row">
                                    {{ f.id }}
                                    <td role="gridcell">{% render_field f.producto class="form-select form-select-sm select2-field producto-select" aria-label="Producto fila {{ forloop.counter }}" %}</td>
                                    <td class="text-center" role="gridcell">{% render_field f.cantidad class="form-control form-control-sm cantidad-input text-center" required="required" aria-label="Cantidad fila {{ forloop.counter }}" placeholder="0" %}</td>
                                    <td class="text-center" role="gridcell">{% render_field f.costo_unitario class="form-control form-control-sm costo-unitario-input text-center" required="required" aria-label="Costo unitario fila {{ forloop.counter }}" placeholder="0" %}</td>
                                    <td class="text-center" role="gridcell">
                                        <!-- Debug: IVA instance value = {{ f.instance.iva }} -->
                                        <input type="hidden" name="{{ f.iva.html_name }}" class="iva-field" value="{% if f.instance.iva %}{{ f.instance.iva }}{% else %}0{% endif %}" data-debug-iva="{{ f.instance.iva }}">
                                        <select class="form-select form-select-sm iva-select text-center" data-row-index="{{ forloop.counter0 }}" data-producto-id="{{ f.instance.producto_id }}" data-tasa-iva-id="{{ f.instance.producto.tasa_iva_id }}" data-iva-value="{{ f.instance.iva }}" aria-label="IVA fila {{ forloop.counter }}">
                                            <option value="">Seleccionar IVA</option>
                                        </select>
                                    </td>
                                    <td class="text-center" role="gridcell">
                                        <input type="date" name="{{ formset.prefix }}-{{ forloop.counter0 }}-fecha_caducidad" class="form-control form-control-sm fecha-caducidad-input" value="{% if f.instance.fecha_caducidad %}{{ f.instance.fecha_caducidad|date:'Y-m-d' }}{% endif %}" aria-label="Fecha de caducidad fila {{ forloop.counter }}" title="Mínimo 5 días de caducidad">
                                    </td>
                                    <td class="text-center fw-bold" role="gridcell">
                                        <span class="subtotal-display">$0</span>
                                    </td>
                                    <td class="text-center" role="gridcell">
                                        <div class="btn-group btn-group-sm" role="group">
                                            <button type="button" class="btn btn-sm btn-outline-secondary delete-row-btn" title="Eliminar (Ctrl+Backspace)" aria-label="Eliminar producto fila {{ forloop.counter }}">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- FOOTER STICKY CON BOTONES DE ACCIÓN -->
                <div class="reab-sticky-footer">
                    <div class="d-flex justify-content-between align-items-center gap-2">
                        <small class="text-muted">
                            <i class="fas fa-keyboard me-1"></i>
                            <kbd>Ctrl</kbd>+<kbd>Enter</kbd> para guardar
                        </small>
                        <div class="d-flex gap-2">
                            <a href="{% url 'suppliers:reabastecimiento_list' %}" class="btn btn-outline-secondary" aria-label="Cancelar y volver a la lista">
                                <i class="fas fa-times me-2"></i>Cancelar
                            </a>
                            <button type="submit" class="btn btn-success" id="guardarReabastecimientoBtn" aria-label="Guardar cambios">
                                <i class="fas fa-save me-2"></i>Guardar Cambios
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

{% include 'inventory/_nueva_categoria_modal.html' %}
{% endblock %}

{% block extra_js %}
<script type="application/json" id="productosData">{{ all_products_json|safe }}</script>
<script type="application/json" id="tasasIVAData">{{ tasas_iva_json|safe }}</script>
<script type="application/json" id="categoriasData">{{ categorias_json|default:"[]"|safe }}</script>
<script>
    const cancelUrl = "{% url 'suppliers:reabastecimiento_list' %}";
    
    // Atajos de teclado
    document.addEventListener('keydown', function(e) {
        if (e.ctrlKey && e.key === 'Enter') {
            e.preventDefault();
            document.querySelector('form').submit();
        }
        if (e.key === 'Escape') {
            e.preventDefault();
            window.location.href = cancelUrl;
        }
    });
    
    // Datos de productos con IVA
    const productosData = JSON.parse(document.getElementById('productosData').textContent || '[]');
    const productMap = new Map(productosData.map(p => [p.id, p]));
    
    // Datos de tasas de IVA
    const tasasIVAData = JSON.parse(document.getElementById('tasasIVAData').textContent || '[]');
    console.log('Tasas de IVA cargadas:', tasasIVAData);
    
    // Validar fecha de caducidad (mínimo 5 días de caducidad)
    function validateFechaCaducidad(dateInput) {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const selectedDate = dateInput.value ? new Date(dateInput.value + 'T00:00:00') : null;
        
        // Limpiar estilos previos
        dateInput.classList.remove('is-invalid', 'is-valid', 'border-warning');
        const existingFeedback = dateInput.parentElement.querySelector('.invalid-feedback, .warning-feedback');
        if (existingFeedback) existingFeedback.remove();
        
        if (!dateInput.value) {
            dateInput.classList.add('is-invalid');
            const feedback = document.createElement('div');
            feedback.className = 'invalid-feedback d-block';
            feedback.textContent = 'Fecha requerida';
            dateInput.parentElement.appendChild(feedback);
            return false;
        }
        
        // Calcular días de diferencia desde HOY
        const diffDays = Math.ceil((selectedDate - today) / (1000 * 60 * 60 * 24));
        
        // Calcular fecha mínima (hoy + 5 días)
        const minDate = new Date(today);
        minDate.setDate(today.getDate() + 5);
        const minDateStr = minDate.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit', year: 'numeric' });
        
        if (diffDays < 5) {
            dateInput.classList.add('is-invalid');
            const feedback = document.createElement('div');
            feedback.className = 'invalid-feedback d-block';
            feedback.textContent = `Mínimo 5 días de caducidad. Fecha mínima: ${minDateStr}`;
            dateInput.parentElement.appendChild(feedback);
            return false;
        } else if (diffDays < 15) {
            dateInput.classList.add('border-warning');
            dateInput.style.borderColor = '#ffc107';
            const feedback = document.createElement('div');
            feedback.className = 'warning-feedback d-block text-warning small mt-1';
            feedback.textContent = `⚠️ Caducidad cercana (${diffDays} días)`;
            dateInput.parentElement.appendChild(feedback);
            return true;
        } else {
            dateInput.classList.add('is-valid');
            return true;
        }
    }
    
    // Validar fechas al cambiar
    document.addEventListener('change', function(e) {
        if (e.target.type === 'date' && e.target.name.includes('fecha_caducidad')) {
            validateFechaCaducidad(e.target);
        }
    });
    
    // Calcular totales en vivo
    document.addEventListener('input', function(e) {
        if (e.target.classList.contains('cantidad-input') || 
            e.target.classList.contains('costo-unitario-input')) {
            // Recalcular el IVA cuando cambian cantidad o costo
            const row = e.target.closest('tr');
            const ivaSelect = row.querySelector('.iva-select');
            const ivaField = row.querySelector('.iva-field');
            const cantidadInput = row.querySelector('.cantidad-input');
            const costoInput = row.querySelector('.costo-unitario-input');
            
            if (ivaSelect && ivaField && cantidadInput && costoInput) {
                const selectedOption = ivaSelect.options[ivaSelect.selectedIndex];
                if (selectedOption && selectedOption.dataset.porcentaje) {
                    const cantidad = parseFloat(cantidadInput.value) || 0;
                    const costo = parseFloat(costoInput.value) || 0;
                    const subtotal = cantidad * costo;
                    const ivaPorcentaje = parseFloat(selectedOption.dataset.porcentaje);
                    const iva = subtotal * (ivaPorcentaje / 100);
                    ivaField.value = iva.toFixed(2);
                }
            }
            
            calculateTotals();
        }
    });
    
    document.addEventListener('change', function(e) {
        if (e.target.classList.contains('producto-select')) {
            updateRowIVA(e.target);
            calculateTotals();
        }
        if (e.target.classList.contains('iva-select')) {
            // Actualizar el campo oculto con el nuevo IVA seleccionado
            const row = e.target.closest('tr');
            const ivaCell = e.target.closest('td');
            const ivaField = ivaCell.querySelector('.iva-field');
            const cantidadInput = row.querySelector('.cantidad-input');
            const costoInput = row.querySelector('.costo-unitario-input');
            
            if (ivaField && cantidadInput && costoInput) {
                const cantidad = parseFloat(cantidadInput.value) || 0;
                const costo = parseFloat(costoInput.value) || 0;
                const selectedOption = e.target.options[e.target.selectedIndex];
                
                // Validar que la opción seleccionada tenga un porcentaje válido
                if (!selectedOption || !selectedOption.dataset.porcentaje) {
                    console.log(`IVA: Opción sin porcentaje seleccionada, no se actualiza`);
                    return;
                }
                
                const ivaPorcentaje = parseFloat(selectedOption.dataset.porcentaje);
                
                const subtotal = cantidad * costo;
                const iva = subtotal * (ivaPorcentaje / 100);
                ivaField.value = iva.toFixed(2);
                console.log(`IVA actualizado: campo=${ivaField.name}, porcentaje=${ivaPorcentaje}%, subtotal=${subtotal}, iva=${iva}`);
            }
            
            calculateTotals();
        }
    });
    
    function updateRowIVA(selectElement) {
        const row = selectElement.closest('tr');
        const productId = parseInt(selectElement.value);
        const ivaSelect = row.querySelector('.iva-select');
        
        if (productId && productMap.has(productId)) {
            const producto = productMap.get(productId);
            const productIvaId = producto.tasa_iva_id;
            
            // Llenar el select con las opciones de IVA
            populateIVASelect(ivaSelect, productIvaId);
        }
    }
    
    function populateIVASelect(ivaSelect, selectedTasaIvaId) {
        // Limpiar opciones previas excepto la primera
        while (ivaSelect.options.length > 1) {
            ivaSelect.remove(1);
        }
        
        // Agregar opciones de tasas de IVA
        if (tasasIVAData && tasasIVAData.length > 0) {
            tasasIVAData.forEach(tasa => {
                const option = document.createElement('option');
                option.value = tasa.id;
                option.textContent = tasa.nombre; // Solo el nombre (ya incluye el porcentaje)
                option.dataset.porcentaje = tasa.porcentaje;
                ivaSelect.appendChild(option);
            });
        }
        
        // Seleccionar la tasa de IVA del producto
        if (selectedTasaIvaId) {
            ivaSelect.value = selectedTasaIvaId;
        }
    }
    
    function calculateTotals() {
        let grandSubtotal = 0;
        let grandIva = 0;

        document.querySelectorAll('tbody tr').forEach(row => {
            const cantidadInput = row.querySelector('.cantidad-input');
            const costoInput = row.querySelector('.costo-unitario-input');
            const ivaField = row.querySelector('.iva-field');
            const subtotalDisplay = row.querySelector('.subtotal-display');

            if (cantidadInput && costoInput) {
                const cantidad = parseFloat(cantidadInput.value) || 0;
                const costo = parseFloat(costoInput.value) || 0;
                const subtotal = cantidad * costo;
                
                // Leer el IVA del campo oculto
                const iva = parseFloat(ivaField?.value) || 0;
                
                const total = subtotal + iva;

                grandSubtotal += subtotal;
                grandIva += iva;

                if (subtotalDisplay) {
                    subtotalDisplay.textContent = formatCurrency(total);
                }
            }
        });

        const grandTotal = grandSubtotal + grandIva;
        document.getElementById('gran-subtotal').textContent = formatCurrency(grandSubtotal);
        document.getElementById('gran-iva').textContent = formatCurrency(grandIva);
        document.getElementById('gran-total').textContent = formatCurrency(grandTotal);
    }

    function formatCurrency(value) {
        return new Intl.NumberFormat('es-CO', {
            style: 'currency',
            currency: 'COP',
            minimumFractionDigits: 0,
            maximumFractionDigits: 0
        }).format(value);
    }
    
    // Inicializar al cargar
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded - Inicializando IVA');
        console.log('Tasas de IVA disponibles:', tasasIVAData);
        
        // Establecer fecha mínima (5 días desde hoy) para todos los campos de fecha
        const today = new Date();
        const minDate = new Date(today);
        minDate.setDate(today.getDate() + 5);
        const minDateStr = minDate.toISOString().split('T')[0];
        
        document.querySelectorAll('input[type="date"][name*="fecha_caducidad"]').forEach(dateInput => {
            dateInput.setAttribute('min', minDateStr);
            console.log(`Fecha mínima establecida: ${minDateStr}`);
        });
        
        // Inicializar IVA para todos los productos ya seleccionados
        document.querySelectorAll('tbody tr').forEach((row, rowIndex) => {
            const ivaSelect = row.querySelector('.iva-select');
            const ivaField = row.querySelector('.iva-field');
            const tasaIvaId = ivaSelect.getAttribute('data-tasa-iva-id');
            const cantidadInput = row.querySelector('.cantidad-input');
            const costoInput = row.querySelector('.costo-unitario-input');
            
            console.log(`Fila ${rowIndex}: tasaIvaId=${tasaIvaId}, ivaField.value=${ivaField?.value}`);
            
            // Obtener el valor del IVA guardado del campo oculto
            let ivaValueSaved = 0;
            if (ivaField && ivaField.value) {
                ivaValueSaved = parseFloat(ivaField.value) || 0;
            }
            
            // Llenar el select con las opciones de IVA
            populateIVASelect(ivaSelect, tasaIvaId);
            
            // Usar el tasaIvaId del producto para seleccionar el IVA correcto
            if (tasaIvaId) {
                // Seleccionar directamente usando el ID de la tasa de IVA del producto
                ivaSelect.value = tasaIvaId;
                console.log(`Fila ${rowIndex}: IVA seleccionado usando tasaIvaId=${tasaIvaId}`);
                
                // Verificar que se seleccionó correctamente
                if (ivaSelect.value === tasaIvaId) {
                    console.log(`Fila ${rowIndex}: ✓ IVA seleccionado correctamente: ${ivaSelect.options[ivaSelect.selectedIndex].text}`);
                    
                    // Recalcular el IVA con los valores actuales
                    if (cantidadInput && costoInput) {
                        const cantidad = parseFloat(cantidadInput.value) || 0;
                        const costo = parseFloat(costoInput.value) || 0;
                        const subtotal = cantidad * costo;
                        const selectedOption = ivaSelect.options[ivaSelect.selectedIndex];
                        
                        if (selectedOption && selectedOption.dataset.porcentaje) {
                            const ivaPorcentaje = parseFloat(selectedOption.dataset.porcentaje);
                            const ivaCalculado = subtotal * (ivaPorcentaje / 100);
                            ivaField.value = ivaCalculado.toFixed(2);
                            console.log(`Fila ${rowIndex}: IVA recalculado: ${ivaPorcentaje}% de ${subtotal} = ${ivaCalculado}`);
                        }
                    }
                } else {
                    console.log(`Fila ${rowIndex}: ✗ Error al seleccionar IVA con tasaIvaId=${tasaIvaId}`);
                }
            } else {
                console.log(`Fila ${rowIndex}: No hay tasaIvaId definido para este producto`);
            }
        });
        calculateTotals();
    });
    
    // Manejador del formulario
    document.getElementById('reabastecimientoForm').addEventListener('submit', function(e) {
        e.preventDefault();
        console.log('=== SUBMIT FORM ===');
        
        const form = this;
        
        // Validar todas las fechas de caducidad antes de enviar
        let fechasValidas = true;
        const fechaInputs = form.querySelectorAll('input[type="date"][name*="fecha_caducidad"]');
        fechaInputs.forEach(dateInput => {
            if (!validateFechaCaducidad(dateInput)) {
                fechasValidas = false;
            }
        });
        
        if (!fechasValidas) {
            Swal.fire({
                icon: 'error',
                title: 'Fechas inválidas',
                text: 'Por favor corrige las fechas de caducidad. Deben ser mínimo 5 días a partir de hoy.',
                confirmButtonColor: '#dc3545'
            });
            return;
        }
        
        // No hacer nada aquí - el IVA ya está en el campo oculto
        // El evento change del select ya actualiza el IVA cuando cambia
        console.log('Enviando formulario con IVA actual');
        
        const formData = new FormData(form);
        const submitBtn = document.getElementById('guardarReabastecimientoBtn');
        const originalBtnText = submitBtn.innerHTML;
        
        // Mostrar estado de carga
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Guardando...';
        
        // Debug: mostrar qué se está enviando
        console.log('=== FormData a enviar ===');
        for (let [key, value] of formData.entries()) {
            console.log(`  ${key}: ${value}`);
        }
        console.log('=== Enviando fetch ===');
        
        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => {
            console.log('=== Respuesta recibida ===');
            console.log('Status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('=== Datos JSON ===', data);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
            
            if (data.error) {
                console.log('Error:', data.error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: data.error,
                    confirmButtonColor: '#dc3545'
                });
            } else if (data.errors) {
                let errorMsg = 'Errores en el formulario:\n';
                for (let field in data.errors) {
                    errorMsg += `${field}: ${data.errors[field].join(', ')}\n`;
                }
                if (data.formset_errors && data.formset_errors.length > 0) {
                    errorMsg += '\nErrores en productos:\n';
                    data.formset_errors.forEach((errors, index) => {
                        for (let field in errors) {
                            errorMsg += `Fila ${index + 1} - ${field}: ${errors[field].join(', ')}\n`;
                        }
                    });
                }
                Swal.fire({
                    icon: 'error',
                    title: 'Errores de validación',
                    text: errorMsg,
                    confirmButtonColor: '#dc3545'
                });
            } else if (data.success) {
                // Éxito - mostrar SweetAlert y luego redirigir
                Swal.fire({
                    icon: 'success',
                    title: '¡Orden actualizada!',
                    html: `
                        <div class="text-start">
                            <p class="mb-2"><strong>Orden #${data.id}</strong></p>
                            <p class="mb-2">Proveedor: ${data.proveedor}</p>
                            <p class="mb-0">Total: ${parseFloat(data.costo_total + data.iva).toLocaleString('es-CO', {style: 'currency', currency: 'COP', minimumFractionDigits: 0})}</p>
                        </div>
                    `,
                    timer: 2500,
                    timerProgressBar: true,
                    showConfirmButton: false,
                    willClose: () => {
                        window.location.href = "{% url 'suppliers:reabastecimiento_list' %}";
                    }
                });
            }
        })
        .catch(error => {
            console.error('=== ERROR EN FETCH ===', error);
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalBtnText;
            showErrorNotification('Error', 'Error al guardar: ' + error);
        });
    });
    
    function showSuccessNotification(title, message, data) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.minWidth = '400px';
        alertDiv.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="fas fa-check-circle me-3" style="font-size: 1.5rem;"></i>
                <div>
                    <strong>${title}</strong>
                    <div style="font-size: 0.9rem; margin-top: 0.25rem;">
                        ${message}
                        <br>
                        <small class="text-muted">Proveedor: ${data.proveedor} | Total: $${parseFloat(data.costo_total).toLocaleString('es-CO')}</small>
                    </div>
                </div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto-cerrar después de 3 segundos y redirigir
        setTimeout(() => {
            alertDiv.remove();
            window.location.href = "{% url 'suppliers:reabastecimiento_list' %}";
        }, 3000);
    }
    
    function showErrorNotification(title, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = 'alert alert-danger alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3';
        alertDiv.style.zIndex = '9999';
        alertDiv.style.minWidth = '400px';
        alertDiv.innerHTML = `
            <div class="d-flex align-items-start">
                <i class="fas fa-exclamation-circle me-3" style="font-size: 1.5rem; margin-top: 0.25rem;"></i>
                <div style="flex: 1;">
                    <strong>${title}</strong>
                    <div style="font-size: 0.9rem; margin-top: 0.5rem; white-space: pre-wrap;">
                        ${message}
                    </div>
                </div>
                <button type="button" class="btn-close ms-auto" data-bs-dismiss="alert"></button>
            </div>
        `;
        document.body.appendChild(alertDiv);
        
        // Auto-cerrar después de 5 segundos
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
</script>
<script src="{% static 'suppliers/js/reabastecimiento_editar_fix.js' %}"></script>
{% endblock %}

